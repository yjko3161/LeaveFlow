{% extends "base.html" %}

{% block header_title %}견적서 상세{% endblock %}

{% block content %}
<style>
    @media print {
        @page {
            size: A4;
            margin: 10mm;
        }

        body {
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .no-print {
            display: none !important;
        }
    }
</style>
<div class="max-w-[210mm] mx-auto p-4 print:p-0 print:max-w-none print:w-full">
    <!-- A4 Paper Layout -->
    <div
        class="bg-white shadow-lg print:shadow-none border border-gray-200 print:border-none p-8 min-h-[297mm] print:min-h-0 relative text-sm">

        <!-- Header: Title & Info Box -->
        <h1 class="text-3xl font-bold text-center mb-12 "
            style="letter-spacing: 0.5em; text-decoration: underline; text-underline-offset: 8px;">견 적 서</h1>

        <div class="flex justify-between items-start mb-8">
            <!-- Left: Client & Meta -->
            <div class="w-1/2 pr-4 space-y-3">
                <div class="flex items-center">
                    <span class="w-24 font-bold text-gray-600">견 적 NO :</span>
                    <span class="font-mono text-base">No. {{ "%04d" % quote.id }}</span>
                </div>
                <div class="flex items-center">
                    <span class="w-24 font-bold text-gray-600">수 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 신 :</span>
                    <span class="font-bold underline text-xl">{{ quote.client_name }} 귀중</span>
                </div>
                <div class="flex items-center">
                    <span class="w-24 font-bold text-gray-600">견 적 일 :</span>
                    <span>{{ quote.created_at.strftime('%Y년 %m월 %d일') }}</span>
                </div>
                <div class="flex items-center">
                    <span class="w-24 font-bold text-gray-600">공 사 명 :</span>
                    <span>{{ quote.title }}</span>
                </div>

                <div class="mt-8 border-b-2 border-black pb-2">
                    <div class="flex items-end justify-between flex-wrap gap-x-4 gap-y-1">
                        <div class="flex items-end">
                            <span class="font-bold w-20 shrink-0 text-gray-600 text-sm mb-1">견적금액:</span>
                            <span class="font-bold tracking-tight text-2xl whitespace-nowrap">일금 {{
                                "{:,}".format(quote.total_amount) }} 원정</span>
                        </div>
                        <div class="flex items-end gap-2 ml-auto">
                            <span class="font-bold text-xl whitespace-nowrap">(₩ {{ "{:,}".format(quote.total_amount)
                                }})</span>
                            <span class="text-[10px] text-gray-500 mb-1">(VAT 별도)</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Provider Box (Table) -->
            <div class="w-1/2 pl-4">
                <table class="w-full border-2 border-black text-center text-xs">
                    <tr>
                        <th rowspan="5" class="bg-gray-100 border-r border-black w-8 py-2 font-bold">공<br>급<br>자</th>
                        <th class="bg-gray-100 border-r border-b border-black w-20 py-2 font-bold">등록번호</th>
                        <td colspan="3" class="border-b border-black py-2 font-bold text-base tracking-wider">{{
                            quote.provider_reg_number }}</td>
                    </tr>
                    <tr>
                        <th class="bg-gray-100 border-r border-b border-black py-2 font-bold">상 호</th>
                        <td class="border-r border-b border-black py-2 font-bold">{{ quote.provider_company_name }}</td>
                        <th class="bg-gray-100 border-r border-b border-black w-14 py-2 font-bold">대 표</th>
                        <td class="border-b border-black py-2 relative min-w-[80px]">
                            <span class="relative z-10">{{ quote.provider_owner_name }}</span>
                            <!-- Stamp -->
                            <div
                                class="absolute top-1/2 right-2 w-12 h-12 pointer-events-none transform -translate-y-1/2 opacity-80 mix-blend-multiply">
                                {% if quote.provider_stamp_path %}
                                <img src="{{ url_for('main.uploaded_file', filename=quote.provider_stamp_path) }}"
                                    class="w-full h-full object-contain" />
                                {% else %}
                                <div
                                    class="w-full h-full border-2 border-red-600 rounded-full flex items-center justify-center">
                                    <span class="text-red-600 font-bold text-[10px]">직인</span>
                                </div>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th class="bg-gray-100 border-r border-b border-black py-2 font-bold">주 소</th>
                        <td colspan="3" class="border-b border-black py-2 text-left px-2 break-keep">{{
                            quote.provider_address }}</td>
                    </tr>
                    <tr>
                        <th class="bg-gray-100 border-r border-b border-black py-2 font-bold">업 태</th>
                        <td class="border-r border-b border-black py-2">{{ quote.provider_business_type }}</td>
                        <th class="bg-gray-100 border-r border-b border-black py-2 font-bold">종 목</th>
                        <td class="border-b border-black py-2">{{ quote.provider_business_item }}</td>
                    </tr>
                    <tr>
                        <th class="bg-gray-100 border-r border-black py-2 font-bold">전 화</th>
                        <td colspan="3" class="py-2">{{ quote.provider_phone }}</td>
                    </tr>
                </table>
            </div>
        </div>

        <p class="mb-4 text-sm font-medium">아래와 같이 견적 합니다.</p>

        <!-- Items Table -->
        <table class="w-full border-t-2 border-b-2 border-black text-xs mb-10">
            <thead>
                <tr class="bg-green-50 text-center border-b border-black">
                    <th class="py-2 w-10 border-r border-gray-300">NO</th>
                    <th class="py-2 border-r border-gray-300">품 목</th>
                    <th class="py-2 w-32 border-r border-gray-300">규 격</th>
                    <th class="py-2 w-12 border-r border-gray-300">수량</th>
                    <th class="py-2 w-12 border-r border-gray-300">단위</th>
                    <th class="py-2 w-24 border-r border-gray-300">단가</th>
                    <th class="py-2 w-28 border-r border-gray-300">금액</th>
                    <th class="py-2 w-20">비고</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for item in quote.items %}
                <tr class="hover:bg-gray-50">
                    <td class="py-2 text-center border-r border-gray-200">{{ loop.index }}</td>
                    <td class="py-2 px-2 border-r border-gray-200 font-medium">{{ item.description }}</td>
                    <td class="py-2 text-center text-gray-500 border-r border-gray-200">{{ item.spec or '' }}</td>
                    <td class="py-2 text-right px-2 border-r border-gray-200">{{ item.quantity }}</td>
                    <td class="py-2 text-center border-r border-gray-200">{{ item.unit or 'EA' }}</td>
                    <td class="py-2 text-right px-2 border-r border-gray-200">{{ "{:,}".format(item.unit_price) }}</td>
                    <td class="py-2 text-right px-2 border-r border-gray-200 font-medium">{{ "{:,}".format(item.amount)
                        }}</td>
                    <td class="py-2"></td>
                </tr>
                {% endfor %}
                <!-- Empty Rows Filler (Ensure min 10 rows for look) -->
                {% for i in range(10 - quote.items|length) %}
                <tr>
                    <td class="py-2 text-center border-r border-gray-100">&nbsp;</td>
                    <td class="py-2 border-r border-gray-100"></td>
                    <td class="py-2 border-r border-gray-100"></td>
                    <td class="py-2 border-r border-gray-100"></td>
                    <td class="py-2 border-r border-gray-100"></td>
                    <td class="py-2 border-r border-gray-100"></td>
                    <td class="py-2 border-r border-gray-100"></td>
                    <td class="py-2"></td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="bg-orange-50 font-bold border-t-2 border-black">
                    <td colspan="6" class="py-2 text-center border-r border-black">합 계 (VAT 별도)</td>
                    <td class="py-2 text-right px-2 border-r border-black text-indigo-700">{{
                        "{:,}".format(quote.total_amount) }}</td>
                    <td class="py-2"></td>
                </tr>
            </tfoot>
        </table>

        <!-- Footer Notes -->
        <div class="border border-black p-5 text-xs leading-relaxed">
            <h4 class="font-bold mb-3 text-sm">[ 특 이 사 항 ]</h4>
            <ul class="list-disc pl-5 space-y-2 text-gray-700">
                <li>견적 유효 기간 : 견적 제출일로부터 15일 이내</li>
                <li>결제 조건 : 계약 후 100% 현금 결제 (세금계산서 발행)</li>
                <li>납품 기한 : 발주 후 2주 이내 (상호 협의 가능)</li>
                <li>본 견적서에 명시되지 않은 사항은 일반적인 상관례에 따릅니다.</li>
            </ul>
        </div>

    </div>

    <!-- Actions -->
    <div class="mt-8 flex justify-end space-x-3 print:hidden">
        <a href="{{ url_for('quote.index') }}"
            class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
            목록으로
        </a>

        <form action="{{ url_for('quote.copy', id=quote.id) }}" method="POST"
            onsubmit="return confirm('이 견적서를 복사하여 새 견적서를 만드시겠습니까?');">
            <button type="submit"
                class="px-4 py-2 bg-green-600 text-white rounded-md text-sm font-medium hover:bg-green-700 shadow-sm">
                복사하여 신규작성
            </button>
        </form>

        <a href="{{ url_for('quote.edit', id=quote.id) }}"
            class="px-4 py-2 bg-gray-600 text-white rounded-md text-sm font-medium hover:bg-gray-700 shadow-sm">
            수정
        </a>

        <button onclick="window.print()"
            class="px-4 py-2 bg-indigo-600 text-white rounded-md text-sm font-medium hover:bg-indigo-700 shadow-sm">
            인쇄 / PDF 저장
        </button>
    </div>
</div>
{% endblock %}