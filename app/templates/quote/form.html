{% extends "base.html" %}

{% block header_title %}
{% if quote %}견적서 수정{% else %}새 견적서 작성{% endif %}
{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto bg-white shadow-sm rounded-lg border border-gray-200 p-8">
    <form action="{{ url_for('quote.edit', id=quote.id) if quote else url_for('quote.new_quote') }}" method="POST"
        class="space-y-8">
        <!-- Top Info -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 border-b pb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">견적 주제 (공사명)</label>
                <input type="text" name="title" required
                    class="w-full border-gray-300 rounded-md shadow-sm border p-2 text-lg"
                    placeholder="예: 2024년 정기 유지보수" value="{{ quote.title if quote else '' }}">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">수신처 (고객사명)</label>
                <input type="text" name="client_name" required
                    class="w-full border-gray-300 rounded-md shadow-sm border p-2 text-lg" placeholder="예: (주)한국상사"
                    value="{{ quote.client_name if quote else '' }}">
            </div>
        </div>

        <!-- Items -->
        <div>
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">견적 품목</h3>
                <button type="button" onclick="addItem()"
                    class="px-3 py-1 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 text-sm font-medium border border-gray-300">
                    + 품목 추가
                </button>
            </div>

            <table class="w-full border-collapse">
                <thead class="bg-gray-50 text-gray-500 text-xs font-medium uppercase tracking-wider">
                    <tr>
                        <th class="p-2 border border-gray-200 w-12 text-center">No</th>
                        <th class="p-2 border border-gray-200">품목명 / 적요</th>
                        <th class="p-2 border border-gray-200 w-32">규격</th>
                        <th class="p-2 border border-gray-200 w-24">단위</th>
                        <th class="p-2 border border-gray-200 w-24">수량</th>
                        <th class="p-2 border border-gray-200 w-32">단가</th>
                        <th class="p-2 border border-gray-200 w-32 text-right">금액</th>
                        <th class="p-2 border border-gray-200 w-12"></th>
                    </tr>
                </thead>
                <tbody id="item-list">
                    {% if quote %}
                    {% for item in quote.items %}
                    <tr class="item-row">
                        <td class="p-2 border border-gray-200 text-center index-cell">{{ loop.index }}</td>
                        <td class="p-2 border border-gray-200">
                            <input type="text" name="desc" class="w-full p-1 border border-gray-300 rounded"
                                value="{{ item.description }}">
                        </td>
                        <td class="p-2 border border-gray-200">
                            <input type="text" name="spec" class="w-full p-1 border border-gray-300 rounded"
                                value="{{ item.spec or '' }}">
                        </td>
                        <td class="p-2 border border-gray-200">
                            <input type="text" name="unit" class="w-full p-1 border border-gray-300 rounded text-center"
                                value="{{ item.unit or 'EA' }}">
                        </td>
                        <td class="p-2 border border-gray-200">
                            <input type="number" name="qty"
                                class="w-full p-1 border border-gray-300 rounded text-right qty-input" min="1"
                                oninput="calcRow(this)" value="{{ item.quantity }}">
                        </td>
                        <td class="p-2 border border-gray-200">
                            <input type="number" name="price"
                                class="w-full p-1 border border-gray-300 rounded text-right price-input" step="1"
                                oninput="calcRow(this)" value="{{ item.unit_price }}">
                        </td>
                        <td class="p-2 border border-gray-200 text-right font-medium text-gray-900 amount-cell">
                            {{ "{:,}".format(item.amount) }}
                        </td>
                        <td class="p-2 border border-gray-200 text-center">
                            <button type="button" onclick="removeRow(this)"
                                class="text-red-500 hover:text-red-700">x</button>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <!-- Default Row for New Quote -->
                    <tr class="item-row">
                        <td class="p-2 border border-gray-200 text-center index-cell">1</td>
                        <td class="p-2 border border-gray-200">
                            <input type="text" name="desc" class="w-full p-1 border border-gray-300 rounded"
                                placeholder="품목명 입력">
                        </td>
                        <td class="p-2 border border-gray-200">
                            <input type="text" name="spec" class="w-full p-1 border border-gray-300 rounded">
                        </td>
                        <td class="p-2 border border-gray-200">
                            <input type="text" name="unit" class="w-full p-1 border border-gray-300 rounded text-center"
                                value="EA">
                        </td>
                        <td class="p-2 border border-gray-200">
                            <input type="number" name="qty"
                                class="w-full p-1 border border-gray-300 rounded text-right qty-input" min="1"
                                oninput="calcRow(this)">
                        </td>
                        <td class="p-2 border border-gray-200">
                            <input type="number" name="price"
                                class="w-full p-1 border border-gray-300 rounded text-right price-input" step="1"
                                oninput="calcRow(this)">
                        </td>
                        <td class="p-2 border border-gray-200 text-right font-medium text-gray-900 amount-cell">0</td>
                        <td class="p-2 border border-gray-200 text-center">
                            <button type="button" onclick="removeRow(this)"
                                class="text-red-500 hover:text-red-700">x</button>
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
                <tfoot>
                    <tr class="bg-gray-50 font-bold">
                        <td colspan="6" class="p-2 text-right border border-gray-200">합계</td>
                        <td class="p-2 text-right border border-gray-200 text-indigo-700" id="total-amount">
                            {{ "{:,}".format(quote.total_amount) if quote else '0' }}
                        </td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="pt-6 flex justify-end space-x-3">
            <a href="{{ url_for('quote.index') }}"
                class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">취소</a>
            <button type="submit"
                class="px-6 py-2 bg-indigo-600 text-white rounded-md text-sm font-medium hover:bg-indigo-700 shadow-sm">
                {{ '수정 저장' if quote else '견적서 생성' }}
            </button>
        </div>
    </form>
</div>

<script>
    function calcRow(input) {
        const row = input.closest('tr');
        const qty = row.querySelector('.qty-input').value || 0;
        const price = row.querySelector('.price-input').value || 0;
        const amount = qty * price;
        row.querySelector('.amount-cell').innerText = amount.toLocaleString();
        calcTotal();
    }

    function calcTotal() {
        let total = 0;
        document.querySelectorAll('.amount-cell').forEach(cell => {
            total += parseInt(cell.innerText.replace(/,/g, '')) || 0;
        });
        document.getElementById('total-amount').innerText = total.toLocaleString();
    }

    function removeRow(btn) {
        const row = btn.closest('tr');
        if (document.querySelectorAll('.item-row').length > 1) {
            row.remove();
            reIndex();
            calcTotal();
        }
    }

    function reIndex() {
        document.querySelectorAll('.item-row').forEach((row, index) => {
            row.querySelector('.index-cell').innerText = index + 1;
        });
    }

    function addItem() {
        const tbody = document.getElementById('item-list');
        const row = document.createElement('tr');
        row.className = 'item-row';
        row.innerHTML = `
            <td class="p-2 border border-gray-200 text-center index-cell"></td>
            <td class="p-2 border border-gray-200">
                <input type="text" name="desc" class="w-full p-1 border border-gray-300 rounded">
            </td>
            <td class="p-2 border border-gray-200">
                <input type="text" name="spec" class="w-full p-1 border border-gray-300 rounded">
            </td>
             <td class="p-2 border border-gray-200">
                <input type="text" name="unit" class="w-full p-1 border border-gray-300 rounded text-center" value="EA">
            </td>
            <td class="p-2 border border-gray-200">
                <input type="number" name="qty" class="w-full p-1 border border-gray-300 rounded text-right qty-input" min="1" oninput="calcRow(this)">
            </td>
            <td class="p-2 border border-gray-200">
                <input type="number" name="price" class="w-full p-1 border border-gray-300 rounded text-right price-input" step="1" oninput="calcRow(this)">
            </td>
            <td class="p-2 border border-gray-200 text-right font-medium text-gray-900 amount-cell">0</td>
            <td class="p-2 border border-gray-200 text-center">
                <button type="button" onclick="removeRow(this)" class="text-red-500 hover:text-red-700">x</button>
            </td>
        `;
        tbody.appendChild(row);
        reIndex();
    }
</script>
{% endblock %}