{% extends "base.html" %}

{% block header_title %}도장/사인 관리{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900">내 도장/사인</h2>
        <button onclick="openStampModal()"
            class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
            + 새 도장/사인 만들기
        </button>
    </div>

    <!-- Asset List -->
    <div id="asset-list-container" hx-get="{{ url_for('stamp.list_assets') }}" hx-trigger="load, stampSaved from:body">
        <div class="flex justify-center py-12">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
        </div>
    </div>
</div>

<!-- Creation Modal -->
<div id="stamp-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true" onclick="closeStampModal()">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>

        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

        <div
            class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">새 도장/사인 생성</h3>
                    <button onclick="closeStampModal()" class="text-gray-400 hover:text-gray-500">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- Tabs -->
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button onclick="switchTab('general')"
                            class="stamp-tab-btn border-indigo-500 text-indigo-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
                            data-tab="general">일반 도장</button>
                        <button onclick="switchTab('corp')"
                            class="stamp-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
                            data-tab="corp">법인 도장</button>
                        <button onclick="switchTab('sign')"
                            class="stamp-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
                            data-tab="sign">사인 만들기</button>
                        <button onclick="switchTab('upload')"
                            class="stamp-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
                            data-tab="upload">업로드</button>
                    </nav>
                </div>

                <!-- Form Controls -->
                <div id="creation-controls" class="space-y-4">
                    <div class="flex space-x-4">
                        <div class="flex-1">
                            <label for="stamp-text" class="block text-sm font-medium text-gray-700">텍스트 입력</label>
                            <input type="text" id="stamp-text"
                                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2 bg-gray-50 border"
                                placeholder="이름 또는 회사명">
                        </div>
                        <div class="w-32">
                            <label for="id_font_style" class="block text-sm font-medium text-gray-700">서체 선택</label>
                            <select id="id_font_style"
                                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2 bg-gray-50 border">
                                <optgroup label="인감 전용 (Traditional)">
                                    <option value="jeonseo">전서체 (Seal Script)</option>
                                    <option value="goinche">고인체 (Old Print)</option>
                                    <option value="gungsuh">궁서체 (Palace Script)</option>
                                    <option value="choseo">초서체 (Cursive)</option>
                                </optgroup>
                                <optgroup label="일반 서체 (General)">
                                    <option value="batang">명조체 (Standard)</option>
                                    <option value="dotum">고딕체 (Modern)</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="w-24">
                            <label for="stamp-lang" class="block text-sm font-medium text-gray-700">언어</label>
                            <select id="stamp-lang"
                                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2 bg-gray-50 border">
                                <option value="ko">한글</option>
                                <option value="zh">한자</option>
                                <option value="en">영문</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="generatePreviews()"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md text-sm font-medium h-[38px]">만들기</button>
                        </div>
                    </div>

                    <!-- Preview Area -->
                    <div id="preview-area"
                        class="mt-6 border rounded-lg p-4 min-h-[200px] bg-gray-50 overflow-y-auto max-h-[400px]">
                        <p class="text-center text-gray-500 py-20">텍스트를 입력하고 [만들기] 버튼을 눌러주세요.</p>
                    </div>
                </div>

                <!-- Upload Section (Hidden by default) -->
                <div id="upload-controls"
                    class="hidden space-y-4 border-2 border-dashed border-gray-300 rounded-lg p-12 text-center">
                    <p class="text-gray-600">준비 중입니다...</p>
                </div>
            </div>

            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse space-x-reverse space-x-2">
                <input type="hidden" id="selected-template-code">
                <input type="hidden" id="current-type" value="general">
                <button type="button" id="btn-save-stamp" disabled onclick="saveSelectedStamp()"
                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm disabled:opacity-50 disabled:cursor-not-allowed">저장하기</button>
                <button type="button" onclick="closeStampModal()"
                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">취소</button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentTab = 'general';

    function openStampModal() {
        document.getElementById('stamp-modal').classList.remove('hidden');
    }

    function closeStampModal() {
        document.getElementById('stamp-modal').classList.add('hidden');
    }

    function switchTab(tab) {
        currentTab = tab;
        document.getElementById('current-type').value = tab;

        // Update Tab UI Styles
        document.querySelectorAll('.stamp-tab-btn').forEach(btn => {
            if (btn.dataset.tab === tab) {
                btn.classList.add('border-indigo-500', 'text-indigo-600');
                btn.classList.remove('border-transparent', 'text-gray-500');
            } else {
                btn.classList.remove('border-indigo-500', 'text-indigo-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            }
        });

        // Toggle Content View
        if (tab === 'upload') {
            document.getElementById('creation-controls').classList.add('hidden');
            document.getElementById('upload-controls').classList.remove('hidden');
        } else {
            document.getElementById('creation-controls').classList.remove('hidden');
            document.getElementById('upload-controls').classList.add('hidden');
        }

        // Reset Preview State
        document.getElementById('preview-area').innerHTML = '<p class="text-center text-gray-500 py-20">텍스트를 입력하고 [만들기] 버튼을 눌러주세요.</p>';
        document.getElementById('btn-save-stamp').disabled = true;
        document.getElementById('selected-template-code').value = '';
    }

    /**
     * Global function to handle stamp selection from the dynamically loaded preview grid.
     */
    function selectStamp(element, code) {
        document.querySelectorAll('.stamp-card').forEach(el => {
            el.classList.remove('selected', 'ring-2', 'ring-indigo-600');
            el.style.borderColor = 'transparent';
        });
        element.classList.add('selected', 'ring-2', 'ring-indigo-600');
        document.getElementById('selected-template-code').value = code;
        document.getElementById('btn-save-stamp').disabled = false;
    }

    function generatePreviews() {
        const text = document.getElementById('stamp-text').value;
        const lang = document.getElementById('stamp-lang').value;
        const fontStyle = document.getElementById('id_font_style').value;
        const type = document.getElementById('current-type').value;

        if (!text) {
            alert('텍스트를 입력해주세요.');
            return;
        }

        const previewArea = document.getElementById('preview-area');
        previewArea.innerHTML = '<div class="flex justify-center py-20"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div></div>';

        fetch(`/stamp/preview?text=${encodeURIComponent(text)}&type=${type}&lang=${lang}&font_style=${fontStyle}`)
            .then(res => res.text())
            .then(html => {
                previewArea.innerHTML = html;
                document.getElementById('btn-save-stamp').disabled = true;
                document.getElementById('selected-template-code').value = '';
            })
            .catch(err => {
                console.error(err);
                previewArea.innerHTML = '<p class="text-center text-red-500 py-20">오류가 발생했습니다.</p>';
            });
    }

    function saveSelectedStamp() {
        const code = document.getElementById('selected-template-code').value;
        const text = document.getElementById('stamp-text').value;
        const type = document.getElementById('current-type').value;

        if (!code || !text) return;

        fetch('/stamp/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ template_code: code, text: text, group: type })
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    closeStampModal();
                    // Trigger htmx to refresh the asset list
                    document.body.dispatchEvent(new Event('stampSaved'));
                } else {
                    alert(data.message || '저장 실패');
                }
            })
            .catch(err => {
                console.error(err);
                alert('저장 도중 오류가 발생했습니다.');
            });
    }

    function deleteAsset(assetId) {
        if (!confirm('정말 삭제하시겠습니까?')) return;

        fetch(`/stamp/delete/${assetId}`, {
            method: 'DELETE'
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    document.body.dispatchEvent(new Event('stampSaved')); // Re-use event to refresh list
                } else {
                    alert(data.message || '삭제 실패');
                }
            })
            .catch(err => {
                console.error(err);
                alert('삭제 도중 오류가 발생했습니다.');
            });
    }

    function downloadPng(svgUrl, filename) {
        const img = new Image();
        img.src = svgUrl;
        img.crossOrigin = "Anonymous";
        img.onload = () => {
            const canvas = document.createElement('canvas');
            // Increase resolution for better quality (2x)
            const scale = 2;
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;

            const ctx = canvas.getContext('2d');
            ctx.scale(scale, scale);
            ctx.drawImage(img, 0, 0);

            const a = document.createElement('a');
            a.download = filename;
            a.href = canvas.toDataURL('image/png');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };
        img.onerror = () => {
            alert('이미지 로드 실패. 관리자에게 문의하세요.');
        };
    }
</script>
{% endblock %}